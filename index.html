<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GPS Tracker + ‡πÄ‡∏™‡∏≤‡πÑ‡∏ü (SP/HM + ‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/‡πÑ‡∏ü‡∏î‡∏±‡∏ö + ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ + ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: "Segoe UI", Tahoma, sans-serif; background: #f5f6fa; }
    #map { height: 100vh; width: 100%; z-index: 1; }

    .leaflet-top.leaflet-left { top: 50px !important; }

    .status-bar {
      position: fixed; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 14px; border-radius: 10px;
      font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000; line-height: 1.4; max-width: 90%;
    }

    .user-input {
      position: fixed; bottom: 65px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 2000; display: flex; align-items: center; gap: 8px;
    }
    .user-input input {
      border: 1px solid #ccc; border-radius: 6px;
      padding: 5px 8px; font-size: 14px; width: 150px;
    }

    .refresh-btn, .track-btn {
      position: fixed; top: 15px;
      background: #007bff; color: white; border: none;
      padding: 10px 14px; border-radius: 8px;
      font-size: 14px; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: background 0.2s ease; z-index: 2000;
    }
    .refresh-btn { right: 15px; }
    .track-btn { left: 15px; background: #28a745; }
    .track-btn.stop { background: #dc3545; }

    .legend {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px;
      font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      line-height: 1.6; z-index: 9999;
    }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #666; }

    .toast {
      position: fixed; top: 20px; right: 20px;
      background: #333; color: white;
      padding: 12px 20px; border-radius: 6px;
      font-size: 14px; opacity: 0;
      transition: opacity 0.5s, transform 0.3s;
      z-index: 3000; transform: translateY(-20px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .btn-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .btn { border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 13px; }
    .btn-green { background: #28a745; color: #fff; }
    .btn-red   { background: #dc3545; color: #fff; }

    .leaflet-div-icon { background: transparent !important; border: none !important; box-shadow: none !important; }
  </style>
</head>
<body>
  <div class="user-input">
    <label for="username">üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</label>
    <input type="text" id="username" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à" />
  </div>

  <button id="trackBtn" class="track-btn">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
  <button id="refreshBtn" class="refresh-btn">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
  <div id="map"></div>
  <div id="status" class="status-bar">üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>

  <div class="legend">
    <b>üó∫Ô∏è ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ:</b>
    <div><span class="legend-color" style="background: #ff66b2;"></span> SP</div>
    <div><span class="legend-color" style="background: #ffd54f;"></span> HM</div>
    <div><span class="legend-color" style="background: green;"></span> ‡πÑ‡∏ü‡∏ï‡∏¥‡∏î (A/B/AB)</div>
    <div><span class="legend-color" style="background: red;"></span> ‡πÑ‡∏ü‡∏î‡∏±‡∏ö (A/B/AB)</div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á -->
  <audio id="ding" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxIPNhZzcPduLQONpuaiMNYP028ZvIZld6_s_mg5x1QFCOEKPF76jDs9RTyq01jbcglTg/exec";
    const PROXY = "https://corsproxy.io/?";

    window.onload = () => {
      const map = L.map('map').setView([13.736717, 100.523186], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      const sheetID = "1KTFaGCzmtjJtezumsWDXFdsWlpZtSriq2mEHe-ujGNc";
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      const toast = document.getElementById("toast");
      const ding = document.getElementById("ding");
      const usernameInput = document.getElementById("username");
      const statusEl = document.getElementById("status");
      const trackBtn = document.getElementById("trackBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      let sheetMarkers = [];
      let userMarker = null, userCircle = null, userPath = [], userPolyline = null, watchID = null;
      let isZoomedIn = false;

      function showToast(msg, type="info") {
        toast.textContent = msg;
        toast.style.background = type === "success" ? "#28a745" : type === "error" ? "#dc3545" : "#333";
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      function colorForStatus(status) {
        if (!status) return "blue";
        if (/^SP/i.test(status)) return "#ff66b2";
        if (/^HM/i.test(status)) return "#ffd54f";
        if (/‡πÑ‡∏ü‡∏î‡∏±‡∏ö/i.test(status)) return "red";
        if (/‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/i.test(status)) return "green";
        return "blue";
      }

      function sendStatusToSheet(name, newStatus) {
        const fullURL = PROXY + encodeURIComponent(WEBHOOK_URL);
        const user = usernameInput.value.trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à";
        fetch(fullURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, status: newStatus, user })
        })
        .then(r => r.json())
        .then(() => showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${newStatus}" ‡πÅ‡∏•‡πâ‡∏ß (${name})`, "success"))
        .catch(e => { console.error(e); showToast("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!", "error"); });
      }

      function createPopup(marker, name, status, color) {
        const div = document.createElement("div");
        div.innerHTML = `
          <b>${name}</b><br>
          üî∞ <b id="statusText" style="color:${color}">${status || "-"}</b><br><br>
          <div class="btn-row">
            <button class="btn btn-green" id="onA">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î A</button>
            <button class="btn btn-green" id="onB">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î B</button>
            <button class="btn btn-green" id="onAB">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î AB</button>
            <button class="btn btn-red" id="offA">‡πÑ‡∏ü‡∏î‡∏±‡∏ö A</button>
            <button class="btn btn-red" id="offB">‡πÑ‡∏ü‡∏î‡∏±‡∏ö B</button>
            <button class="btn btn-red" id="offAB">‡πÑ‡∏ü‡∏î‡∏±‡∏ö AB</button>
          </div>
        `;
        const popup = L.popup().setContent(div);
        marker.bindPopup(popup);

        marker.on("popupopen", () => {
          const statusEl = div.querySelector("#statusText");

          function updateStatus(newStatus) {
            const newColor = colorForStatus(newStatus);
            statusEl.style.color = newColor;
            statusEl.textContent = newStatus;
            marker.setIcon(L.divIcon({
              html: `<div style='background:${newColor};width:18px;height:18px;border-radius:50%;border:2px solid white;'></div>`
            }));
            ding.currentTime = 0; ding.play();
            marker.closePopup();
            sendStatusToSheet(name, newStatus);
          }

          document.getElementById("onA").onclick = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îA");
          document.getElementById("onB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îB");
          document.getElementById("onAB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏ï‡∏¥‡∏îAB");
          document.getElementById("offA").onclick = () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öA");
          document.getElementById("offB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öB");
          document.getElementById("offAB").onclick = () => updateStatus("‡πÑ‡∏ü‡∏î‡∏±‡∏öAB");
        });
      }

      function loadSheetData() {
        fetch(sheetURL)
          .then(res => res.text())
          .then(text => {
            sheetMarkers.forEach(m => map.removeLayer(m)); sheetMarkers = [];
            const json = JSON.parse(text.substring(47).slice(0, -2));
            const rows = json.table.rows;
            rows.forEach(r => {
              const name = r.c[0]?.v, lat = r.c[1]?.v, lng = r.c[2]?.v, status = r.c[8]?.v || "";
              if (lat && lng) {
                const color = colorForStatus(status);
                const icon = L.divIcon({ html: `<div style='background:${color};width:18px;height:18px;border-radius:50%;border:2px solid white;'></div>` });
                const m = L.marker([lat, lng], { icon, name }).addTo(map);
                createPopup(m, name, status, color);
                sheetMarkers.push(m);
              }
            });
            if (sheetMarkers.length) map.fitBounds(L.featureGroup(sheetMarkers).getBounds());
            statusEl.innerHTML = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString();
          })
          .catch(e => { console.error(e); statusEl.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; });
      }

      function startTracking() {
        if (watchID) return;
        showToast("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...", "success");
        trackBtn.textContent = "‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
        trackBtn.classList.add("stop");

        if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => {});

        watchID = navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          if (userMarker) map.removeLayer(userMarker);
          if (userCircle) map.removeLayer(userCircle);

          userMarker = L.marker([latitude, longitude], { icon: L.divIcon({ html: "üìç" }) }).addTo(map);
          userCircle = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);

          userPath.push([latitude, longitude]);
          if (userPolyline) map.removeLayer(userPolyline);
          userPolyline = L.polyline(userPath, { color: "#007bff", weight: 4 }).addTo(map);

          map.setView([latitude, longitude], 17);
          checkNearbyMarkers(latitude, longitude);
          statusEl.innerHTML = `üìç ${latitude.toFixed(5)}, ${longitude.toFixed(5)} (¬±${accuracy.toFixed(1)} m)`;
        }, () => showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ!", "error"), { enableHighAccuracy: true });
      }

      function stopTracking() {
        if (!watchID) return;
        navigator.geolocation.clearWatch(watchID);
        watchID = null;
        trackBtn.textContent = "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°";
        trackBtn.classList.remove("stop");
        showToast("üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß", "info");

        if (document.fullscreenElement) document.exitFullscreen().catch(() => {});
      }

      trackBtn.onclick = () => { if (watchID) stopTracking(); else startTracking(); };

      function checkNearbyMarkers(lat, lng) {
        sheetMarkers.forEach(marker => {
          const dist = map.distance([lat, lng], marker.getLatLng());
          if (dist < 5 && !isZoomedIn) {
            isZoomedIn = true;
            map.setView(marker.getLatLng(), 19, { animate: true });
            marker.openPopup();
            ding.currentTime = 0; ding.play(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ marker
            showToast(`üì° ‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∏‡∏î ${marker.options.name} ‡∏£‡∏∞‡∏¢‡∏∞ ${dist.toFixed(1)} ‡∏°.`, "info");
          } else if (dist >= 10 && isZoomedIn) {
            isZoomedIn = false;
          }
        });
      }

      loadSheetData();
      setInterval(loadSheetData, 300000);
      refreshBtn.onclick = loadSheetData;
    };
  </script>
</body>
</html>
