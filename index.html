<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GPS Tracker + ‡πÄ‡∏™‡∏≤‡πÑ‡∏ü (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡∏ù‡∏±‡πà‡∏á)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: "Segoe UI", Tahoma, sans-serif; background: #f5f6fa; }
    #map { height: 100vh; width: 100%; z-index: 1; }

    .status-bar {
      position: fixed; bottom: 10px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 14px; border-radius: 10px;
      font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 1000; line-height: 1.4; max-width: 90%;
    }

    .refresh-btn {
      position: fixed; top: 15px; right: 15px;
      background: #007bff; color: white; border: none;
      padding: 10px 14px; border-radius: 8px; font-size: 14px; font-weight: bold;
      cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 2000; transition: background 0.2s ease;
    }
    .refresh-btn:hover { background: #0056b3; }

    .legend {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px; font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25); line-height: 1.6; z-index: 9999;
    }
    .legend div { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #666; flex-shrink: 0; }

    .toast {
      position: fixed; top: 20px; right: 20px; background: #333; color: white;
      padding: 12px 20px; border-radius: 6px; font-size: 14px; opacity: 0;
      transition: opacity 0.5s, transform 0.3s; z-index: 3000; transform: translateY(-20px);
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .user-input {
      position: fixed; bottom: 65px; left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 10px 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 2000; display: flex; align-items: center; gap: 8px;
    }
    .user-input input { border: 1px solid #ccc; border-radius: 6px; padding: 5px 8px; font-size: 14px; width: 150px; }
    .user-input label { font-size: 14px; font-weight: 600; }

    .btn-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .btn {
      border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 13px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .btn-green { background: #28a745; color: #fff; }
    .btn-red   { background: #dc3545; color: #fff; }

    @media (max-width: 600px) {
      .status-bar { font-size: 12px; bottom: 8px; left: 8px; padding: 8px 10px; }
      .legend { font-size: 12px; bottom: 70px; right: 8px; padding: 8px 10px; }
      .user-input { bottom: 60px; left: 8px; padding: 8px 10px; }
      .user-input input { width: 120px; font-size: 13px; }
    }
  </style>
</head>

<body>
  <div class="user-input">
    <label for="username">üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à:</label>
    <input type="text" id="username" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à" />
  </div>

  <button id="refreshBtn" class="refresh-btn">üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
  <div id="map"></div>
  <div id="status" class="status-bar">üïì ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...</div>

  <div class="legend">
    <b>üó∫Ô∏è ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ:</b>
    <div><span class="legend-color" style="background: green;"></span> ‡πÑ‡∏ü‡∏ï‡∏¥‡∏î (A/B/AB)</div>
    <div><span class="legend-color" style="background: red;"></span> ‡πÑ‡∏ü‡∏î‡∏±‡∏ö (A/B/AB)</div>
  </div>

  <div id="toast" class="toast"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbxIPNhZzcPduLQONpuaiMNYP028ZvIZld6_s_mg5x1QFCOEKPF76jDs9RTyq01jbcglTg/exec";
    const PROXY = "https://corsproxy.io/?";

    window.onload = () => {
      const map = L.map('map').setView([13.736717, 100.523186], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

      const sheetID = "1KTFaGCzmtjJtezumsWDXFdsWlpZtSriq2mEHe-ujGNc";
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

      const toast = document.getElementById("toast");
      const usernameInput = document.getElementById("username");
      const statusEl = document.getElementById("status");
      let sheetMarkers = [];

      // toast
      function showToast(msg, type="info") {
        toast.textContent = msg;
        toast.style.background = type === "success" ? "#28a745" : type === "error" ? "#dc3545" : "#333";
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3000);
      }

      const savedUser = localStorage.getItem("username");
      if (savedUser) usernameInput.value = savedUser;
      usernameInput.addEventListener("change", () => localStorage.setItem("username", usernameInput.value));

      function colorForStatus(s) {
        if (!s) return "blue";
        if (/‡πÑ‡∏ü‡∏î‡∏±‡∏ö/i.test(s)) return "red";
        if (/‡πÑ‡∏ü‡∏ï‡∏¥‡∏î/i.test(s)) return "green";
        return "blue";
      }

      function sendStatusToSheet(name, newStatus) {
        const fullURL = PROXY + encodeURIComponent(WEBHOOK_URL);
        const user = usernameInput.value.trim() || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à";

        fetch(fullURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, status: newStatus, user })
        })
        .then(r => r.json())
        .then(() => showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${newStatus}" ‡πÅ‡∏•‡πâ‡∏ß (${name})`, "success"))
        .catch(e => { console.error(e); showToast("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß!", "error"); });
      }

      function updateMarker(marker, newStatus) {
        const color = colorForStatus(newStatus);
        marker.setIcon(L.divIcon({
          html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`
        }));
        marker.setPopupContent(`<b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:</b> ${newStatus}`);
        sendStatusToSheet(marker.options.name, newStatus);
      }

      function createPopup(marker, name, status, color) {
        const popupContent = document.createElement("div");
        popupContent.innerHTML = `
          <b>${name}</b><br>
          üî∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b style="color:${color}">${status || "-"}</b><br><br>
          <div style="font-weight:600;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü:</div>
          <div class="btn-row">
            <button id="onA"  class="btn btn-green">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î A</button>
            <button id="onB"  class="btn btn-green">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î B</button>
            <button id="onAB" class="btn btn-green">‡πÑ‡∏ü‡∏ï‡∏¥‡∏î AB</button>
            <button id="offA" class="btn btn-red">‡πÑ‡∏ü‡∏î‡∏±‡∏ö A</button>
            <button id="offB" class="btn btn-red">‡πÑ‡∏ü‡∏î‡∏±‡∏ö B</button>
            <button id="offAB" class="btn btn-red">‡πÑ‡∏ü‡∏î‡∏±‡∏ö AB</button>
          </div>
        `;
        const popup = L.popup().setContent(popupContent);
        marker.bindPopup(popup);
        marker.on("popupopen", () => {
          document.getElementById("onA").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏ï‡∏¥‡∏îA"));
          document.getElementById("onB").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏ï‡∏¥‡∏îB"));
          document.getElementById("onAB").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏ï‡∏¥‡∏îAB"));
          document.getElementById("offA").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏î‡∏±‡∏öA"));
          document.getElementById("offB").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏î‡∏±‡∏öB"));
          document.getElementById("offAB").addEventListener("click", () => updateMarker(marker, "‡πÑ‡∏ü‡∏î‡∏±‡∏öAB"));
        });
      }

      function loadSheetData() {
        fetch(sheetURL)
        .then(res => res.text())
        .then(text => {
          sheetMarkers.forEach(m => map.removeLayer(m)); sheetMarkers = [];
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const rows = json.table.rows;
          rows.forEach(r => {
            const name = r.c[0]?.v, lat = r.c[1]?.v, lng = r.c[2]?.v, status = r.c[8]?.v || "";
            if (lat && lng) {
              const color = colorForStatus(status);
              const marker = L.marker([lat, lng], {
                icon: L.divIcon({ html: `<div style="background:${color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>` }),
                name
              }).addTo(map);
              createPopup(marker, name, status, color);
              sheetMarkers.push(marker);
            }
          });
          if (sheetMarkers.length) map.fitBounds(L.featureGroup(sheetMarkers).getBounds());
          statusEl.innerHTML = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: " + new Date().toLocaleTimeString();
        });
      }

      loadSheetData();
      setInterval(loadSheetData, 300000);
      document.getElementById("refreshBtn").addEventListener("click", loadSheetData);
    };
  </script>
</body>
</html>
